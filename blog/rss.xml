<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Go-Kitx Blog</title>
        <link>https://sado0823.github.io/blog</link>
        <description>Go-Kitx Blog</description>
        <lastBuildDate>Tue, 24 May 2022 22:25:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Clean Architecture]]></title>
            <link>https://sado0823.github.io/blog/clean-architecture</link>
            <guid>clean-architecture</guid>
            <pubDate>Tue, 24 May 2022 22:25:00 GMT</pubDate>
            <description><![CDATA[&ensp;&ensp;&ensp;&ensp;最近感觉网络上贩卖的焦虑实在是太多了, 其实以前也多多少少有这种感觉, 最近尤为严重, 可能也和开年后工作强度变大有关吧, 搞的身心比较疲惫. 一些专业性比较强的书也看不进去了, 拿起来之前没有看完的 Bob 大叔整洁系列的书慢慢看完了, 不得不说, 看书确实是一种比较好的降压方式, 本篇文章主要记录一些书中的内容.]]></description>
            <content:encoded><![CDATA[<p> <!-- --> <!-- --> <!-- --> <!-- -->最近感觉网络上贩卖的焦虑实在是太多了, 其实以前也多多少少有这种感觉, 最近尤为严重, 可能也和开年后工作强度变大有关吧, 搞的身心比较疲惫. 一些专业性比较强的书也看不进去了, 拿起来之前没有看完的 Bob 大叔整洁系列的书慢慢看完了, 不得不说, 看书确实是一种比较好的降压方式, 本篇文章主要记录一些书中的内容.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="1-介绍">1) 介绍<a class="hash-link" href="#1-介绍" title="Direct link to heading">​</a></h2><p> <!-- --> <!-- --> <!-- --> <!-- -->这本书为 Bob 大叔(Robert C. Martin)的著名作品, 同系列的还有《代码整洁之道》, 都是经典作品, 值得阅读. 该书系统的剖析了架构设计的缘起, 内涵以及应用场景.</p><ul><li><p>第 1 部分描述架构设计的<code>重点</code>与<code>模式</code></p></li><li><p>第 2~4 部分主要为<code>编程范式</code></p></li><li><p>第 5 部分为架构设计中的<code>组件边界</code>、<code>设计模式</code>等</p></li><li><p>第 6 部分为<code>实现细节</code></p></li><li><p>附录部分为作者的一些亲身经历等</p></li></ul><p> <!-- --> <!-- --> <!-- --> <!-- -->这个系列其实还有一本作品 - 《代码整洁之道 - 程序员的职业素养》(The Clean Coder - A code of Conduct For Professional Programmers), 主要讲述作者的一些经历, 如何走上编程道路等, 同样推荐阅读. 读完不禁感叹, 大神的成长之路也不是一帆风顺的, 其中经验虽然不能说一定适用于现在, 但是完全值得我们学习和借鉴的.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="2-设计与架构究竟是什么">2) 设计与架构究竟是什么<a class="hash-link" href="#2-设计与架构究竟是什么" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-目标">1) 目标<a class="hash-link" href="#1-目标" title="Direct link to heading">​</a></h3><p>软件架构的终极目标</p><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">用最小的人力成本满足构建和维护该系统的需求</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-两个价值维度">2) 两个价值维度<a class="hash-link" href="#2-两个价值维度" title="Direct link to heading">​</a></h3><p>可以从<code>两个价值维度</code>来描述</p><ul><li><h4 class="anchor anchorWithStickyNavbar_mojV" id="行为价值">行为价值<a class="hash-link" href="#行为价值" title="Direct link to heading">​</a></h4></li></ul><p>是最直观的价值维度, 程序员的工作就是让机器按照某种指定方式运行, 给系统的使用者创造或者提高利润.</p><p>大部分程序员认为这就是他们的全部工作. 他们的工作是且仅是:</p><p><code>按照需求文档编写代码, 并且修复任何Bug.</code></p><p>这是大错特错的.</p><ul><li><h4 class="anchor anchorWithStickyNavbar_mojV" id="架构价值">架构价值<a class="hash-link" href="#架构价值" title="Direct link to heading">​</a></h4></li></ul><p>软件系统的第二个价值维度, 是指软件的灵活性, 软件必须保持灵活.</p><p>从系统相关方的角度来看, 他们提出的一系列的变更需求范畴都是类似的, 因此成本也应该是固定的.</p><p>但是从研发者角度来看, 系统用户持续不断的变更需求就像是要求他们不停的用一堆不同形状的拼图块, 拼出一个新的形状, 整个过程将会越来越困难. <code>问题的根源就是系统的架构设计</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-哪个价值维度更重要">3) 哪个价值维度更重要<a class="hash-link" href="#3-哪个价值维度更重要" title="Direct link to heading">​</a></h3><p> <!-- --> <!-- --> <!-- --> <!-- -->不同的人给出的答案会不一样. 业务部门觉得系统正常工作很重要, 很多开发人员也跟随采取了这种态度, 但是 Bob 大叔认为这种态度是错误的.</p><ul><li>可以正常工作, 但是无法修改. 那么当需求变更时, 它将无法正常工作, 我们也无法修改, 因此价值为 0</li><li>无法正常工作, 易于修改. 可以随着续期变化不断修改, 不断产生价值.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-艾森豪威尔矩阵">4) 艾森豪威尔矩阵<a class="hash-link" href="#4-艾森豪威尔矩阵" title="Direct link to heading">​</a></h3><table><thead><tr><th align="center">重要且紧急</th><th align="center">重要不紧急</th></tr></thead><tbody><tr><td align="center">不重要但紧急</td><td align="center">不重要且不紧急</td></tr></tbody></table><p> <!-- --> <!-- --> <!-- --> <!-- -->重要的事情占据了前面两位, 开发人员和业务部门经常犯的共同错误就是把第三优先级<code>不重要但紧急</code>的事情提到了第一优先级去做, 也就是说没有把<code>真正紧急且重要</code>和<code>紧急但是不重要</code>的功能分开, 这个错误导致了重要的事被忽略了, 重要的系统架构问题让位给了不重要的系统行为功能.</p><p> <!-- --> <!-- --> <!-- --> <!-- -->但是研发人员还忘记了一点, 那就是业务部门原本就是没有能力评估系统架构的重要程度的, <code>这本来就应该是研发人员自己的工作职责</code>.</p><p> <!-- --> <!-- --> <!-- --> <!-- -->如果忽视软件架构的价值, 系统将会变得越来越难以维护, 终会有一条, 系统将会变得无法修改. 如果系统变成了这个样子, 那么说明软件开发团队没有和需求方做足够的抗争, 没有完成自己应尽的职责.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="3-编程范式">3) 编程范式<a class="hash-link" href="#3-编程范式" title="Direct link to heading">​</a></h2><p> <!-- --> <!-- --> <!-- --> <!-- -->编程范式指的是程序的编写模式, 与具体的编程语言关系较小, 这些范式会告诉你应该在什么时候采用什么样的代码结构. 直到今天, 我们也一共只有三个编程范式, 而且未来几乎不可能出现新的.</p><p> <!-- --> <!-- --> <!-- --> <!-- -->每个编程范式都从某一方面<code>限制</code>和<code>规范</code>了程序员的能力, 这些范式主要是为了告诉我们不能做什么, 而不是可以做什么.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-结构化编程">1) 结构化编程<a class="hash-link" href="#1-结构化编程" title="Direct link to heading">​</a></h3><p><code>结构化编程对程序控制权的直接转移进行了限制和规范</code></p><p>主张限制<code>goto</code>等无限制的跳转语句, 使用熟知的<code>if/then/else/do/while/until</code>等语句来进行替换</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-面向对象编程">2) 面向对象编程<a class="hash-link" href="#2-面向对象编程" title="Direct link to heading">​</a></h3><p><code>面向对象编程对程序控制权的间接转移进行了限制和规范</code></p><p>三大特性为<code>封装</code>、 <code>继承</code>、 <code>多态</code>, 涉及到的概念还有<code>控制反转</code>(实现方式有<code>依赖注入</code>), 现代代表语言有 java 等...</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-函数式编程">3) 函数式编程<a class="hash-link" href="#3-函数式编程" title="Direct link to heading">​</a></h3><p><code>函数式编程对程序中的赋值进行了限制和规范</code></p><p> <!-- --> <!-- --> <!-- --> <!-- -->从理论上来说, 函数式编程语言中应该是没有赋值语句的, 大部分函数式编程语言只允许在非常严格的条件下, 才可以更改某个变量的值.</p><p>当然上面说的只是一种思想, 实际运用起来肯定还是有差别的, 现代代表语言有 golang 等...</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="4-solid-设计原则">4) SOLID 设计原则<a class="hash-link" href="#4-solid-设计原则" title="Direct link to heading">​</a></h2><p> <!-- --> <!-- --> <!-- --> <!-- -->通常来说, 想要构建一个好的软件系统, 应该从写整洁的代码开始(可以看看 Bob 大叔的《代码整洁之道》). <code>SOLID设计原则</code>就是用来解决这样的问题, 告诉我们如何组织数据和函数等.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-s---单一职责原则">1) S - 单一职责原则<a class="hash-link" href="#1-s---单一职责原则" title="Direct link to heading">​</a></h3><p> <!-- --> <!-- --> <!-- --> <!-- -->基于<code>康威定律(Conway's Law)</code>的一个推论, 一个软件系统的最佳架构高度依赖于开发这个系统组织的内部结构. 这样, 每个软件的模块都有且只有一个需要被改变的原则.</p><p>康威定律: 软件架构能够反映出制作团队的组织架构</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-o---开闭原则">2) O - 开闭原则<a class="hash-link" href="#2-o---开闭原则" title="Direct link to heading">​</a></h3><p> <!-- --> <!-- --> <!-- --> <!-- -->由<code>Bertrand Meyer</code>在 20 世纪 80 年代大力推广, 核心要素为: 如果软件系统要想更容易被改变, 那么其设计就必须允许新增代码来修改系统行为, 而非只能靠修改原来的代码.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-l---里氏替换原则">3) L - 里氏替换原则<a class="hash-link" href="#3-l---里氏替换原则" title="Direct link to heading">​</a></h3><p> <!-- --> <!-- --> <!-- --> <!-- -->由<code>Barbara Liskov</code>在 1988 年提出的一个子类型定义, 简而言之为: 如果要用可替换的组件来构建软件系统, 那么这些组件必须遵守同一个约定, 以便让这些组件可以相互替换.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-i---接口隔离原则">4) I - 接口隔离原则<a class="hash-link" href="#4-i---接口隔离原则" title="Direct link to heading">​</a></h3><p> <!-- --> <!-- --> <!-- --> <!-- -->主要告诫软件设计师应该再设计中避免不必要的依赖</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-d---依赖反转原则">5) D - 依赖反转原则<a class="hash-link" href="#5-d---依赖反转原则" title="Direct link to heading">​</a></h3><p> <!-- --> <!-- --> <!-- --> <!-- -->该设计原则指出: 高层策略性的代码不应该依赖实现底层细节的代码, 恰恰相反, 那些实现底层细节的代码应该依赖高层策略性的代码</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="5-软件架构">5) 软件架构<a class="hash-link" href="#5-软件架构" title="Direct link to heading">​</a></h2><p> <!-- --> <!-- --> <!-- --> <!-- -->Bob 大叔书中有个观点我个人非常认可. 首先, <code>软件架构师自身需要是程序员, 并且必须一直坚持做一线程序员, 绝对不要听从那些说应该让软件架构师从代码中解放出来以专心解决高阶问题的伪建议</code>. 如果不亲身承受因系统设计而带来的麻烦, 就体会不到设计不佳所带来的的痛苦, 接着就会逐渐迷失正确的设计方向.</p><p>软件系统的架构质量是由它的构建者所决定的, 软件架构这项工作的实质就是:</p><p><code>规划如何将系统切分为组件, 并且安排好组件之间的排列关系, 以及组件之间相互通信的方式.</code></p><p>包含以下方面:</p><ul><li><h4 class="anchor anchorWithStickyNavbar_mojV" id="开发development">开发(Development)<a class="hash-link" href="#开发development" title="Direct link to heading">​</a></h4></li><li><h4 class="anchor anchorWithStickyNavbar_mojV" id="部署deployment">部署(Deployment)<a class="hash-link" href="#部署deployment" title="Direct link to heading">​</a></h4></li><li><h4 class="anchor anchorWithStickyNavbar_mojV" id="运行operation">运行(Operation)<a class="hash-link" href="#运行operation" title="Direct link to heading">​</a></h4></li><li><h4 class="anchor anchorWithStickyNavbar_mojV" id="维护maintenance">维护(Maintenance)<a class="hash-link" href="#维护maintenance" title="Direct link to heading">​</a></h4></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="6-整洁架构">6) 整洁架构<a class="hash-link" href="#6-整洁架构" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-一些基本的架构特点">1) 一些基本的架构特点<a class="hash-link" href="#1-一些基本的架构特点" title="Direct link to heading">​</a></h3><ul><li>六边形架构</li><li>DCI 架构</li><li>BCE 架构</li></ul><p>基本特点:</p><ul><li>独立于框架</li><li>可被测试</li><li>独立于 UI</li><li>独立于数据库</li><li>独立于任何外部机构</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-整洁构建">2) 整洁构建<a class="hash-link" href="#2-整洁构建" title="Direct link to heading">​</a></h3><p> <!-- --> <!-- --> <!-- --> <!-- -->这是 Bob 大叔根据一般性架构特点总结出来的一个独立概念</p><p><img loading="lazy" alt="image-20220313120349217" src="/assets/images/image-20220313120349217-17b56e8e3368a6f9b0590f912c6972c0.png" width="1122" height="810" class="img_E7b_"></p><ul><li><h5 class="anchor anchorWithStickyNavbar_mojV" id="依赖关系规则">依赖关系规则<a class="hash-link" href="#依赖关系规则" title="Direct link to heading">​</a></h5></li></ul><p> <!-- --> <!-- --> <!-- --> <!-- -->源码中的依赖关系规则必须只指向同心圆的内层, 即由底层机制指向高层策略</p><ul><li><h5 class="anchor anchorWithStickyNavbar_mojV" id="业务实体">业务实体<a class="hash-link" href="#业务实体" title="Direct link to heading">​</a></h5></li></ul><p> <!-- --> <!-- --> <!-- --> <!-- -->业务实体这一层封装的是整个系统的关键业务逻辑, 一个业务实体既可以是一个带有方法的对象, 也可以是一组数据结构的集合. 无论如何, 只要它能被系统中的其它不同应用复用就可以.</p><ul><li><h5 class="anchor anchorWithStickyNavbar_mojV" id="用例">用例<a class="hash-link" href="#用例" title="Direct link to heading">​</a></h5></li></ul><p> <!-- --> <!-- --> <!-- --> <!-- -->通常包含的是<code>特定应用场景下</code>的业务逻辑, 这里面封装并实现了整个系统的所有用例. 这些用例引导了数据在业务实体之间的流入和流出, 并指挥着<code>业务实体</code>利用其中的关键业务逻辑来实现用例的设计目标</p><p>用例层应该与<code>业务实体</code>和<code>外部因素</code>(比如数据库、UI、框架等)隔离</p><ul><li><h5 class="anchor anchorWithStickyNavbar_mojV" id="接口适配器">接口适配器<a class="hash-link" href="#接口适配器" title="Direct link to heading">​</a></h5></li></ul><p> <!-- --> <!-- --> <!-- --> <!-- -->软件的接口适配器通常是一组<code>数据转换器</code>, 转换成各层所需要的数据格式</p><ul><li><h5 class="anchor anchorWithStickyNavbar_mojV" id="框架与驱动程序">框架与驱动程序<a class="hash-link" href="#框架与驱动程序" title="Direct link to heading">​</a></h5></li></ul><p> <!-- --> <!-- --> <!-- --> <!-- -->最外层的<code>模型层</code>一般是由工具、数据库、Web 框架等组成的, 在这一层中, 我们通常只需要编写一些与内部沟通的粘合性代码.</p><p> <!-- --> <!-- --> <!-- --> <!-- -->框架与驱动程序层中包含了所有的实现细节. Web 是实现细节, 数据库也是实现细节, 将这些实现细节放在最外层, 这样他们就很难影响到其它层了.</p><ul><li><h5 class="anchor anchorWithStickyNavbar_mojV" id="只有四层吗">只有四层吗<a class="hash-link" href="#只有四层吗" title="Direct link to heading">​</a></h5></li></ul><p> <!-- --> <!-- --> <!-- --> <!-- -->只是为了说明结构和依赖关系, 并不是表示只能有 4 层. 有可能会超过四层, 但是其中的依赖关系是不会改变的.</p><p> <!-- --> <!-- --> <!-- --> <!-- -->源码层面的依赖关系一定要指向同心圆的内侧, 层次越往内, 其抽象和策略的层次就越高, 其包含的高层策略就越多. <code>最内层的圆中包含的是最通用、最高层的策略, 最外层的圆包含的是最具体的细节</code></p><p> <!-- --> <!-- --> <!-- --> <!-- -->感兴趣的同学还可以去看看现在大火的<code>DDD -领域驱动设计 </code>(Domain Drive Design)的思想, 不免可以找到一些共通之处.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="7-结束语">7) 结束语<a class="hash-link" href="#7-结束语" title="Direct link to heading">​</a></h2><p> <!-- --> <!-- --> <!-- --> <!-- -->希望大家能够有所收获, 成为自己心中想成为的架构师.</p>]]></content:encoded>
            <category>architecture</category>
            <category>uncle bob</category>
        </item>
        <item>
            <title><![CDATA[Docker And Docker-Compose]]></title>
            <link>https://sado0823.github.io/blog/docker-and-compose</link>
            <guid>docker-and-compose</guid>
            <pubDate>Tue, 24 May 2022 18:50:00 GMT</pubDate>
            <description><![CDATA[1、why docker ?]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="1why-docker-">1、why docker ?<a class="hash-link" href="#1why-docker-" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="image-20200913225025739" src="/assets/images/image-20200913225025739-cc1be9155dae0ad44f9f247f353d5d2f.png" width="2600" height="1172" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="2about">2、about<a class="hash-link" href="#2about" title="Direct link to heading">​</a></h2><p><code>repository</code>、<code>image</code>、<code>container</code>、<code>tag</code></p><p><img loading="lazy" alt="image-20200913230214621" src="/assets/images/image-20200913230214621-8dfa2df56f7e05fdc755112e3264fb6e.png" width="1302" height="1044" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="3how-to-use-">3、how to use ?<a class="hash-link" href="#3how-to-use-" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-command">1) command<a class="hash-link" href="#1-command" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 以守护进程模式启动Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo service docker start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置开机自动启动Docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 拉取镜像 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull python</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2.7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker images</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 删除镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker rmi id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看容器 运行中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker ps </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token function" style="color:#d73a49">查看网络</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">veth pair</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker network ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> bridge</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> none</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> overlay</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># docker run 启动容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d 后台运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name 指定容器名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> 端口映射</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">root 目录映射</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">link 链接容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">nwtwork 指定网络</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c 添加运行时cmd 命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e 添加环境变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># docker exec name </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it 交互模式进入容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">interactive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">tty    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-example">2) example<a class="hash-link" href="#2-example" title="Direct link to heading">​</a></h3><div class="language-linux codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-linux codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">-- 启动nginx容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -it --name web-n1 -p 80:80 -v /var/www/html:/usr/share/nginx/html -d nginx:alpine</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20200913233850606" src="/assets/images/image-20200913233850606-164e3ef62e382a78763ce05f3a39b082.png" width="1086" height="194" class="img_E7b_"></p><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">--</span><span class="token plain"> 启动redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name rds </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p </span><span class="token number" style="color:#36acaa">6379</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">6379</span><span class="token plain"> redis</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">--</span><span class="token plain"> 链接容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">link rds </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name app</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e </span><span class="token constant" style="color:#36acaa">REDIS_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rds app</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.0</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-dockerfile">3) dockerfile<a class="hash-link" href="#3-dockerfile" title="Direct link to heading">​</a></h3><div class="language-dockerfile codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-dockerfile codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">dokcerfile构建:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼FROM  : 来源基础镜像 (scratch -&gt; 所有镜像原始镜像)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼MAINTAINER :  作者&lt;邮箱&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼RUN : 容器构建需要执行的命令 (创建用户组 , 创建文件夹 , 安装包 等)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN yum -y install vim </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN yum -y install net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN mkdir /var/wwwroot </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">建议如下使用 , 使用 &amp; 连接 : </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN yum -y install vim \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;&amp; yum -y install net-tools \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;&amp; mkdir /var/wwwroot </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼EXPOSE : 暴露的端口号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼WORKDIR : 指定在创建并且进去容器终端后的工作目录(无指定到 / 根目录)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼ENV : 构建镜像过程中设置的环境变量 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENV MY_PATH /var/wwwroot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR $MY_PATH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼ADD : 将宿主机目录下的文件拷贝进镜像 , 并且会自动处理url和解压tar压缩包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼COPY : 类似add , 拷贝到镜像, 没有处理功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼VALUME : 容器数据卷, 用于数据持久化 , 容器中创建指定的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼CMD : 指定容器启动时运行的命令 ( 多个命令只有最后一个生效 , 会被docker run之后的参数覆盖)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼ENTRYPOINT : 与cmd功能一样 , 会在docker run之后的参数追加命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">￼ONBUILD : 当构建一个被继承的dockerfile时运行命令,父镜像在被子镜像继承后父镜像的onbuild被触发</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-dockerfile codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-dockerfile codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">FROM python:3.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY . /var/www/app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /var/www/app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip install flask redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXPOSE 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD [ "python","app.py" ]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-python codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-python codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> redis </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Redis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'REDIS_HOST'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">'127.0.0.1'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">prot</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6379</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">incr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">incr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'like'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'current like = %s, current host = %s \n'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'like'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gethostname</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"0.0.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 使用dockerfile构建镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">tag </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f template </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">docker</span><span class="token plain"> build </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t app</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 运行构建镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">link rds</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name app</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p </span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e </span><span class="token constant" style="color:#36acaa">REDIS_HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rds</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> app</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 进入容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">it app</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl </span><span class="token number" style="color:#36acaa">0.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> current like </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token string" style="color:#e3116c">'1'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bc33562a73ea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> current like </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token string" style="color:#e3116c">'2'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bc33562a73ea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> current like </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token string" style="color:#e3116c">'3'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current host </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bc33562a73ea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-cluster-example">4) cluster example<a class="hash-link" href="#4-cluster-example" title="Direct link to heading">​</a></h3><p><code>etcd + docker</code></p><p> <code>overlay network</code></p><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dockerd </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">H</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">tcp</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">0.0.0.02375 -H unix:</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token comment" style="color:#999988;font-style:italic">//var/run/docker.sock --cluster-store=etcd://192.168.xxx.xx:2379 --cluster-advertise=192.168.xxx.xx1:2375&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dockerd </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">H</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">tcp</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">0.0.0.02375 -H unix:</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token comment" style="color:#999988;font-style:italic">//var/run/docker.sock --cluster-store=etcd://192.168.xxx.xx:2379 --cluster-advertise=192.168.xxx.xx2:2375&amp;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="4docker-compose">4、docker-compose<a class="hash-link" href="#4docker-compose" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-config-yml">1) config yml<a class="hash-link" href="#1-config-yml" title="Direct link to heading">​</a></h3><p><code>docker-compose.yml</code></p><div class="language-docker-compose codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-docker-compose codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">version: "3"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rds:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  app:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context: .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dockerfile: Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ports: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - 80:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        environment: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          REDIS_HOST: rds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-scale">2) scale<a class="hash-link" href="#2-scale" title="Direct link to heading">​</a></h3><p><code>--scale</code></p><p><code>docker-compose up --scale app=3 -d</code></p><div class="language-docker-compose codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-docker-compose codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">version: '3'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rds:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  app:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context: .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dockerfile: Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # - 80:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      REDIS_HOST: rds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lib:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: dockercloud/haproxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    links:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - 80:80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - /var/run/docker.sock:/var/run/docker.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-command">3) command<a class="hash-link" href="#3-command" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">cd </span><span class="token operator" style="color:#393A34">~</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compose up </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compose stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compose restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compose down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compose build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-cluster">4) cluster<a class="hash-link" href="#4-cluster" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">k8s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> swarm</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>golang</category>
            <category>docker</category>
            <category>docker-compose</category>
        </item>
        <item>
            <title><![CDATA[Opentrace Demo]]></title>
            <link>https://sado0823.github.io/blog/opentrace-demo</link>
            <guid>opentrace-demo</guid>
            <pubDate>Tue, 24 May 2022 18:40:00 GMT</pubDate>
            <description><![CDATA[一、前言]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="一前言">一、前言<a class="hash-link" href="#一前言" title="Direct link to heading">​</a></h2><p>​		上文介绍了 <code>trace</code> 的 由来, 以及简单应用, 今天我们就来实际用代码操作一下, 看看到底如何简单, 方便的在项目中接入 <code>trace</code></p><p>​		一般我们会采用中间件的方式在web库中接入, 各大主流的web库(如<code>gin</code>,<code>iris</code>)都有自己的中间件方式, 整体上都是大同小异的, 由于作者的项目中使用的是<code>iris</code>库, 今天我们采用 <code>iris</code> 来进行demo演示</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="二准备">二、准备<a class="hash-link" href="#二准备" title="Direct link to heading">​</a></h2><p>1、<code>iris</code>  <!-- -->[https://github.com/kataras/iris]</p><p>2、<code>redis</code>  <!-- -->[https://github.com/go-redis/redis]</p><p>3、<code>gorm</code> <!-- -->[https://github.com/go-gorm/gorm]</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="三实现">三、实现<a class="hash-link" href="#三实现" title="Direct link to heading">​</a></h2><p>​		实现的原理其实也很简单, 主要是通过 <code>golang</code> 的内置包 <code>context</code>进行变量传递, 再不通过的调用处都开启一个新的 <code>span</code>, 最终所有的span都连接起来, 就是实现了我们的整个链路了, 其实 <code>rpc</code> 的调用通用可以加上去</p><p>​		原理弄清楚之后, 就要开始写代码了, 那么怎么在<code>redis</code>也好, <code>gorm</code>也好, 我们传入<code>context</code>的时候, 程序就会帮我们自动处理生成<code>trace</code>呢?</p><p>​		这个时候就需要我们去做一些面向切面的东西, <code>gorm</code>里面我们可以实现一个插件来做, <code>redis</code>这个也有同样的实现</p><p>​		</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-gorm-插件">1) gorm 插件:<a class="hash-link" href="#1-gorm-插件" title="Direct link to heading">​</a></h3><p>gorm中的插件定义是为<code>interface</code></p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Plugin </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Plugin GORM plugin </span><span class="token keyword" style="color:#00009f">interface</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们只需要实现这个 <code>interface</code> 即可使用:</p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"fmt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/opentracing/opentracing-go"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/opentracing/opentracing-go/ext"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracerLog </span><span class="token string" style="color:#e3116c">"github.com/opentracing/opentracing-go/log"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"gorm.io/driver/mysql"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"gorm.io/gorm"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"strings"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callBackBeforeName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"opentracing:before"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    callBackAfterName  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"opentracing:after"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> OpenTracingPlugin </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> gorm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Plugin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">OpenTracingPlugin</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">OpenTracingPlugin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"openTracingPlugin"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">OpenTracingPlugin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gorm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 开始前 - 并不是都用相同的方法，可以自己自定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:before_create"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackBeforeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> before</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:query"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackBeforeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> before</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:before_delete"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackBeforeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> before</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:setup_reflect_value"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackBeforeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> before</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Row</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:row"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackBeforeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> before</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:raw"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackBeforeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> before</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 结束后 - 并不是都用相同的方法，可以自己自定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">After</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:after_create"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackAfterName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">After</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:after_query"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackAfterName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">After</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:after_delete"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackAfterName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">After</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:after_update"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackAfterName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Row</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">After</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:row"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackAfterName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">After</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gorm:raw"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Register</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">callBackAfterName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// do logic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> _GormSpan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_GormSpan"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gorm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsGlobalTracerRegistered</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operationName </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Mysql - %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Table</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartSpanFromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> operationName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DBType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"sql"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"db.table"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Table</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dialector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mysql</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dialector</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DSN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"tcp("</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DBInstance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DSN</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 记录当前span</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InstanceSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_GormSpan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">after</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gorm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isExist </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InstanceGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_GormSpan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isExist </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> _span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Span</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Finish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tracerLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 记录sql</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DBStatement</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dialector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Explain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SQL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Vars</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tracerLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"sql"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dialector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Explain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SQL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Vars</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 记录影响行数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"db.count"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowsAffected</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 截取 sql 表示记录方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"db.method"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToUpper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Statement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SQL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如何使用 ?</p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 实例化gorm db后, 直接调用 use 方法进行插件使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">OpenTracingPlugin</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-redis-hook">2) redis hook<a class="hash-link" href="#2-redis-hook" title="Direct link to heading">​</a></h3><p>在我们使用的 <code>redis</code>包中, 上述功能叫做<code>hook</code>, 其实<code>hook</code>的定义同样为一个<code>interface</code>:</p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Hook </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">BeforeProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">AfterProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">BeforeProcessPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmds </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">AfterProcessPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmds </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同理, 我们来实现这个 <code>interface</code>:</p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"context"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"fmt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/go-redis/redis/v8"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/opentracing/opentracing-go"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/opentracing/opentracing-go/ext"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracerLog </span><span class="token string" style="color:#e3116c">"github.com/opentracing/opentracing-go/log"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/pkg/errors"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TracingHook </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> RedisSpanKey </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> _RedisSpan RedisSpanKey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_RedisSpan"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Hook </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TracingHook</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TracingHook</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">BeforeProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsGlobalTracerRegistered</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operationName </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Redis - %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartSpanFromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> operationName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DBType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"redis"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"redis.name"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"redis.full_name"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FullName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogKV</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"redis.cmd"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"redis.args"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Args</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    withValueCtx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _RedisSpan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> withValueCtx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TracingHook</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AfterProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_RedisSpan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Span</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Finish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">errors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Is</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tracerLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TracingHook</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">BeforeProcessPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmds </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsGlobalTracerRegistered</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operationName </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Redis - %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Pipeline"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartSpanFromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> operationName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmdMap </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> cmds </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cmdMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DBType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"redis"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogKV</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Pipeline"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmdMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    withValueCtx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _RedisSpan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> withValueCtx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TracingHook</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AfterProcessPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmds </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cmder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_RedisSpan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Span</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Finish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmd </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> cmds </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">span</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tracerLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样在我们实例化<code>redis</code>之后, 即可直接使用</p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">redisDB</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TracingHook</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-iris-middleware">3) iris middleware<a class="hash-link" href="#3-iris-middleware" title="Direct link to heading">​</a></h3><p>接下来, 我们需要编写一个 <code>iris</code>的中间件, 让每次请求进来的时候, 自动开启一条新的链路</p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Trace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> iris</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Handler </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c iris</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> parentSpan opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Span</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        spCtx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GlobalTracer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HTTPHeaders</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HTTPHeadersCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            parentSpan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GlobalTracer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartSpan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">URL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            parentSpan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GlobalTracer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StartSpan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">"call grpc"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ChildOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spCtx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SpanKindRPCServer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 重置request ctx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ContextWithSpan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parentSpan</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ResetRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> parentSpan</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Finish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4) 启动</p><p>初始化一个全局 <code>tracer</code>, 并且启动服务:</p><div class="language-go codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-go codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"fmt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/go-redis/redis/v8"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/kataras/iris/v12"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/kataras/iris/v12/context"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/opentracing/opentracing-go"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"github.com/uber/jaeger-client-go"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jaegerConfig </span><span class="token string" style="color:#e3116c">"github.com/uber/jaeger-client-go/config"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"gorm-trace/middleware"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mysql2 </span><span class="token string" style="color:#e3116c">"gorm-trace/mysql"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redis2 </span><span class="token string" style="color:#e3116c">"gorm-trace/redis"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"gorm.io/driver/mysql"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"gorm.io/gorm"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"time"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化trace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cfg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">jaegerConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Configuration</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Sampler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">jaegerConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SamplerConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"const"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//固定采样</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Param</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">//1=全采样、0=不采样</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Reporter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">jaegerConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReporterConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LogSpans</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">           </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LocalAgentHostPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.0.0.0:6831"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServiceName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"test-trace"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tracer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> closer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTracer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jaegerConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Logger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jaeger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StdLogger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"ERROR: cannot init Jaeger: %v\n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> closer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    opentracing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetGlobalTracer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tracer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> iris</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 调用trace 中间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">middleware</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Trace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/trace"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> User </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ID   </span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        res </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">User</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化mysql</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sqlDB </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initMysql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sqlDB</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"users"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化redis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        redisDB </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initRedis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        redisDB</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"i-am-key"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"i-am-value"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Hour</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">":7787"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"init web fail"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initMysql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gorm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DB </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> gorm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysql</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysql</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DSN</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%s/%s?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"root:root@tcp(127.0.0.1:3306)"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"gongjiayun"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// DSN data source name, parse time is important !!!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultStringSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">256</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                     </span><span class="token comment" style="color:#999988;font-style:italic">// string default length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SkipInitializeWithVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// auto config according to version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">gorm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"fail to init mysql: "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mysql2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OpenTracingPlugin</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initRedis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redisDB </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">redis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":6379"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    redisDB</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">redis2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TracingHook</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> redisDB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="四效果">四、效果<a class="hash-link" href="#四效果" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-概览">1) 概览<a class="hash-link" href="#1-概览" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20210419215247142" src="/assets/images/image-20210419215247142-a450f1117d3442da96cdfea9f47c9efa.png" width="3258" height="956" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-mysql">2) mysql<a class="hash-link" href="#2-mysql" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20210419215359449" src="/assets/images/image-20210419215359449-a946618abc852eee0ce280833722cc10.png" width="2722" height="1024" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-redis">3) redis<a class="hash-link" href="#3-redis" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20210419215511821" src="/assets/images/image-20210419215511821-b8b49b7ca1079088bc8ba770697c0f4b.png" width="2964" height="922" class="img_E7b_"></p><p>以上链路中的<code>tag</code>信息是可以根据自己需求自定义的</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="五源码">五、源码<a class="hash-link" href="#五源码" title="Direct link to heading">​</a></h2><p><a href="https://github.com/sado0823/gorm-redis-trace" target="_blank" rel="noopener noreferrer">https://github.com/sado0823/gorm-redis-trace</a></p>]]></content:encoded>
            <category>golang</category>
            <category>opentrace</category>
            <category>gorm</category>
            <category>redis</category>
            <category>mysql</category>
        </item>
        <item>
            <title><![CDATA[Rpc And Opentrace]]></title>
            <link>https://sado0823.github.io/blog/rpc-opentrace</link>
            <guid>rpc-opentrace</guid>
            <pubDate>Tue, 24 May 2022 18:37:00 GMT</pubDate>
            <description><![CDATA[1) RPC]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="1-rpc">1) RPC<a class="hash-link" href="#1-rpc" title="Direct link to heading">​</a></h2><p><code>Remote Procedure Call</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-概览">1) 概览<a class="hash-link" href="#1-概览" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20201123112838249" src="/assets/images/image-20201123112838249-96c83fdcafb3e9e492bff5c96e55ea8a.png" width="1474" height="870" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-优势">2) 优势<a class="hash-link" href="#2-优势" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">    简单、通用、安全、效率</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="2-grpc">2) GRPC<a class="hash-link" href="#2-grpc" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-简介">1) 简介<a class="hash-link" href="#1-简介" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">gRPC 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>ps: 多语言支持</code></p><ul><li>C++</li><li>C#</li><li>Dart</li><li>Go</li><li>Java</li><li>Node.js</li><li>Objective-C</li><li>PHP</li><li>Python</li><li>Ruby</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-概览">2) 概览<a class="hash-link" href="#2-概览" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20201123113804847" src="/assets/images/image-20201123113804847-1ad3e4be690f8226e00bc642e0a4c744.png" width="1142" height="722" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-protocol-buffers">3) Protocol Buffers<a class="hash-link" href="#3-protocol-buffers" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">Protocol Buffers是一种与语言无关，平台无关的可扩展机制，用于序列化结构化数据。使用Protocol Buffers可以一次定义结构化的数据，然后可以使用特殊生成的源代码轻松地在各种数据流中使用各种语言编写和读取结构化数据</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>​	</p><p>示例</p><p><code>example.proto</code></p><div class="language-protobuf codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-protobuf codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = "proto3"; // 版本声明，使用Protocol Buffers v3版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package pb; // 包名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 定义服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service Trainee {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpc Sing (HelloRequest) returns (HelloReply) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpc Dance (HelloRequest) returns (HelloReply) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpc Rap (HelloRequest) returns (HelloReply) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 请求消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message HelloRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string name = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 响应消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message HelloReply {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string message = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="3-opentrace">3) opentrace<a class="hash-link" href="#3-opentrace" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1--官网">1) <a href="https://opentracing.io/" target="_blank" rel="noopener noreferrer"> 官网</a><a class="hash-link" href="#1--官网" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20201123120307807" src="/assets/images/image-20201123120307807-1419ca3cb7b8240ef2632a772e5386e7.png" width="2756" height="1440" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-问题">2) 问题<a class="hash-link" href="#2-问题" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">解耦成大量微服务时，以前很容易实现的重点任务变得困难了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">过程中需要面临一系列问题：用户体验优化、后台错误原因分析，分布式系统内各组件的调用情况等</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-why-open-trace">3) why open trace?<a class="hash-link" href="#3-why-open-trace" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">OpenTracing通过提供平台无关、厂商无关的API，使得开发人员能够方便的添加（或更换）追踪系统的实现。</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 多语言支持</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Go, JavaScript, Java, Python, Ruby, PHP, Objective-C, C++, C#</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-概念">4) 概念<a class="hash-link" href="#4-概念" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="1-trace">1) trace<a class="hash-link" href="#1-trace" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">trace代表了一个事务或者流程在（分布式）系统中的执行过程</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="2-span">2) span<a class="hash-link" href="#2-span" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">span代表trace中被命名并计时的连续性的执行片段</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20201123141732427" src="/assets/images/image-20201123141732427-c1e3a67f49b3192f57701be1a55752e2.png" width="1062" height="548" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="4-jaeger">4) jaeger<a class="hash-link" href="#4-jaeger" title="Direct link to heading">​</a></h2><h4 class="anchor anchorWithStickyNavbar_mojV" id="1-官网">1) <a href="https://www.jaegertracing.io/" target="_blank" rel="noopener noreferrer">官网</a><a class="hash-link" href="#1-官网" title="Direct link to heading">​</a></h4><p><img loading="lazy" alt="image-20201123143744308" src="/assets/images/image-20201123143744308-f6c7fb8e0d9d74c602e3657c47df25ee.png" width="3090" height="1598" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="2-简介">2) 简介<a class="hash-link" href="#2-简介" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">Jaeger是Uber的分布式跟踪系统。</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20201123143527158" src="/assets/images/image-20201123143527158-7e7d46b4ca2d266aaa66d404c2ed24ce.png" width="1312" height="650" class="img_E7b_"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="3-安装">3) 安装<a class="hash-link" href="#3-安装" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="1-docker">1) <code>docker</code><a class="hash-link" href="#1-docker" title="Direct link to heading">​</a></h5><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d --name test-jaeger \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -u root \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --privileged=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 5775:5775/udp \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 6831:6831/udp \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 6832:6832/udp \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 5778:5778 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 16686:16686 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 14268:14268 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 14250:14250 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -p 9411:9411 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  jaegertracing/all-in-one:1.21</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="2-官网下载二进制文件">2) 官网下载二进制文件<a class="hash-link" href="#2-官网下载二进制文件" title="Direct link to heading">​</a></h5><p><code>...</code></p><h5 class="anchor anchorWithStickyNavbar_mojV" id="3-github下载发行版本">3) github下载发行版本<a class="hash-link" href="#3-github下载发行版本" title="Direct link to heading">​</a></h5><p><code>...</code></p><p>浏览器输入 <code>http://0.0.0.0:16686/</code>, 看到以下界面则表示成功</p><p><img loading="lazy" alt="image-20210413094929946" src="/assets/images/image-20210413094929946-01016b04281e6311e0be35d58ea92232.png" width="2810" height="1164" class="img_E7b_"></p>]]></content:encoded>
            <category>golang</category>
            <category>opentrace</category>
            <category>grpc</category>
        </item>
        <item>
            <title><![CDATA[Websocket And Swoft]]></title>
            <link>https://sado0823.github.io/blog/websocket-swoft</link>
            <guid>websocket-swoft</guid>
            <pubDate>Tue, 24 May 2022 18:35:00 GMT</pubDate>
            <description><![CDATA[1.Websocket]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="1websocket">1.Websocket<a class="hash-link" href="#1websocket" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1osi七层与tcpip五层模型">1.OSI七层与TCP/IP五层模型<a class="hash-link" href="#1osi七层与tcpip五层模型" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20200415173221790" src="/assets/images/image-20200415173221790-61efc04913f5a5f158ba5cab30ce8d33.png" width="2342" height="850" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2socket">2.socket<a class="hash-link" href="#2socket" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">Socket实际上是对</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">协议的封装，本身并不是协议，而是一个调用接口（</span><span class="token constant" style="color:#36acaa">API</span><span class="token plain">）</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">Socket的出现只是使得程序员更方便地使用</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">协议栈而已，是对</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">IP</span><span class="token plain">协议的抽象，从而形成了我们知道的一些最基本的函数接口</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">比如create、listen、connect、accept、send、read和write</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3简介">3.简介<a class="hash-link" href="#3简介" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">WebSocket</span><span class="token plain"> 是一种网络通信协议</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">WebSocket</span><span class="token plain"> 协议在</span><span class="token number" style="color:#36acaa">2008</span><span class="token plain">年诞生，</span><span class="token number" style="color:#36acaa">2011</span><span class="token plain">年成为国际标准。所有浏览器都已经支持了</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，属于服务器推送技术的一种。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">长链接</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 服务器推送技术</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">   </span><span class="token maybe-class-name">Webpush</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> server push</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">   </span><span class="token maybe-class-name">Pushlet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">   </span><span class="token maybe-class-name">Long</span><span class="token plain"> polling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">5</span><span class="token plain">   </span><span class="token maybe-class-name">Flash</span><span class="token plain"> </span><span class="token maybe-class-name">XMLSocket</span><span class="token plain"> relays</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">6</span><span class="token plain">   </span><span class="token maybe-class-name">Reliable</span><span class="token plain"> </span><span class="token maybe-class-name">Group</span><span class="token plain"> </span><span class="token maybe-class-name">Data</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">Delivery</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">RGDD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">7</span><span class="token plain">   </span><span class="token maybe-class-name">Push</span><span class="token plain"> notification</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="4与http的对比">4.与HTTP的对比<a class="hash-link" href="#4与http的对比" title="Direct link to heading">​</a></h3><p><img loading="lazy" alt="image-20200415174047471" src="/assets/images/image-20200415174047471-98428b01264e2fd92038a1175aa003eb.png" width="1248" height="1018" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="5特点">5.特点<a class="hash-link" href="#5特点" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">）建立在 </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"> 协议之上，服务器端的实现比较容易。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">）与 </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 协议有着良好的兼容性。默认端口也是</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">80</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">和</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">443</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">，并且握手阶段采用 </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 协议，因此握手时不容易屏蔽，能通过各种 </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 代理服务器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">）数据格式比较轻量，性能开销小，通信高效。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">）可以发送文本，也可以发送二进制数据。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（</span><span class="token number" style="color:#36acaa">5</span><span class="token plain">）没有</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">同源限制</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">，客户端可以与任意服务器通信。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（</span><span class="token number" style="color:#36acaa">6</span><span class="token plain">）协议标识符是</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">ws</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">（如果加密，则为wss），服务器网址就是 </span><span class="token constant" style="color:#36acaa">URL</span><span class="token function" style="color:#d73a49">。</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scheme</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">ws</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">wss</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">uri</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="6示例">6.示例<a class="hash-link" href="#6示例" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WebSocket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"wss://echo.websocket.org"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onopen</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">evt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Connection open ..."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Hello WebSockets!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">evt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Received Message: "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> evt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onclose</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">evt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Connection closed."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">php </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">socket_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Socket</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> socket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> gorilla</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">websocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> socket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">io</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">client</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 调试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jsbin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">js</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">console</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">output</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># webSocket</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">readyState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">readyState属性返回实例对象的当前状态，共有四种。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">CONNECTING</span><span class="token plain">：值为</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">，表示正在连接。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">OPEN</span><span class="token plain">：值为</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">，表示连接成功，可以通信了。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">CLOSING</span><span class="token plain">：值为</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">，表示连接正在关闭。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">CLOSED</span><span class="token plain">：值为</span><span class="token number" style="color:#36acaa">3</span><span class="token plain">，表示连接已经关闭，或者打开连接失败。</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="2swoole">2.swoole<a class="hash-link" href="#2swoole" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1简介">1.简介<a class="hash-link" href="#1简介" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">作者 韩天峰 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pecl开发组成员</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">php扩展</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Swoole</span><span class="token plain"> 是一个 </span><span class="token constant" style="color:#36acaa">PHP</span><span class="token plain"> 的 </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">协程</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">高性能</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> 网络通信引擎，使用 </span><span class="token constant" style="color:#36acaa">C</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">C</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> 语言编写，提供了多种通信协议的网络服务器和客户端模块。可以方便快速的实现 </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token operator" style="color:#393A34">/</span><span class="token constant" style="color:#36acaa">UDP</span><span class="token plain">服务、高性能Web、WebSocket服务、物联网、实时通讯、游戏、微服务等，使 </span><span class="token constant" style="color:#36acaa">PHP</span><span class="token plain"> 不再局限于传统的 </span><span class="token maybe-class-name">Web</span><span class="token plain"> 领域。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4.4</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">之后</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 全面协程化</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PHP</span><span class="token plain"> 协程框架 </span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 文档</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">www.swoole.com</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>php-fpm` 处理请求</p><p><code>sapi</code>---&gt; 初始化http的环境变量</p><p><code>phpcore</code> ---&gt; 初始化php拓展, 初始化上下文环境</p><p><img loading="lazy" alt="image-20200417173904872" src="/assets/images/image-20200417173904872-a5a221aecea7659c6d93da4b581c2c90.png" width="1672" height="858" class="img_E7b_"></p><p><code>执行php脚本</code></p><p><img loading="lazy" alt="image-20200417173929936" src="/assets/images/image-20200417173929936-68a1b530933812347193d6a2af7fbcaa.png" width="1190" height="1280" class="img_E7b_"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2示例">2.示例<a class="hash-link" href="#2示例" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="1http-server">1.http server<a class="hash-link" href="#1http-server" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">        $http = new Swoole\Http\Server("127.0.0.1", 9501);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $http-&gt;on("start", function ($server) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "Swoole http server is started at http://127.0.0.1:9501\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $http-&gt;on("request", function ($request, $response) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $response-&gt;header("Content-Type", "text/plain");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $response-&gt;end("Hello World\n");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $http-&gt;start();</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="2websocket-server">2.websocket server<a class="hash-link" href="#2websocket-server" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">        $server = new Swoole\Websocket\Server("127.0.0.1", 9502);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('open', function($server, $req) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "connection open: {$req-&gt;fd}\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('message', function($server, $frame) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "received message: {$frame-&gt;data}\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $server-&gt;push($frame-&gt;fd, json_encode(["hello", "world"]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('close', function($server, $fd) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "connection close: {$fd}\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="3tcp-server">3.tcp server<a class="hash-link" href="#3tcp-server" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">        $server = new Swoole\Server("127.0.0.1", 9503);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('connect', function ($server, $fd){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "connection open: {$fd}\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('receive', function ($server, $fd, $reactor_id, $data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $server-&gt;send($fd, "Swoole: {$data}");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $server-&gt;close($fd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('close', function ($server, $fd) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "connection close: {$fd}\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;start();</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="4udp-server">4.udp server<a class="hash-link" href="#4udp-server" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">        $serv = new Swoole\Server("127.0.0.1", 9502, SWOOLE_PROCESS, SWOOLE_SOCK_UDP);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //监听数据接收事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $serv-&gt;on('Packet', function ($serv, $data, $clientInfo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $serv-&gt;sendto($clientInfo['address'], $clientInfo['port'], "Server ".$data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var_dump($clientInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //启动服务器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $serv-&gt;start();</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="5task">5.task<a class="hash-link" href="#5task" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">$server = new Swoole\Server("127.0.0.1", 9502);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;set(array('task_worker_num' =&gt; 4));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('receive', function($server, $fd, $reactor_id, $data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $task_id = $server-&gt;task("Async");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "Dispatch AsyncTask: [id=$task_id]\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('task', function ($server, $task_id, $reactor_id, $data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "New AsyncTask[id=$task_id]\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $server-&gt;finish("$data -&gt; OK");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;on('finish', function ($server, $task_id, $data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo "AsyncTask[$task_id] finished: {$data}\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $server-&gt;start();</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="6coroutine">6.coroutine<a class="hash-link" href="#6coroutine" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">//睡眠 1 万次，读取，写入，检查和删除文件 1 万次，使用 PDO 和 MySQLi 与数据库通信 1 万次，创建 TCP 服务器和多个客户端相互通信 1 万次，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//创建 UDP 服务器和多个客户端到相互通信 1 万次...... 一切都在一个进程一秒内完美完成！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Swoole\Runtime::enableCoroutine();//此行代码后，文件操作，sleep，Mysqli，PDO，streams等都变成异步IO，见文档'一键协程化'章节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   $s = microtime(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Co/run()见文档'协程容器'章节</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Co\run(function() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // i just want to sleep...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for ($c = 100; $c--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go(function () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for ($n = 100; $n--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                usleep(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 10k file read and write</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for ($c = 100; $c--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go(function () use ($c) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $tmp_filename = "/tmp/test-{$c}.php";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for ($n = 100; $n--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $self = file_get_contents(__FILE__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                file_put_contents($tmp_filename, $self);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                assert(file_get_contents($tmp_filename) === $self);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unlink($tmp_filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 10k pdo and mysqli read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for ($c = 50; $c--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go(function () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $pdo = new PDO('mysql:host=127.0.0.1;dbname=test;charset=utf8', 'root', 'root');</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $statement = $pdo-&gt;prepare('SELECT * FROM `user`');</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for ($n = 100; $n--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $statement-&gt;execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                assert(count($statement-&gt;fetchAll()) &gt; 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for ($c = 50; $c--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go(function () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $mysqli = new Mysqli('127.0.0.1', 'root', 'root', 'test');</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $statement = $mysqli-&gt;prepare('SELECT `id` FROM `user`');</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for ($n = 100; $n--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $statement-&gt;bind_result($id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $statement-&gt;execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $statement-&gt;fetch();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                assert($id &gt; 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // php_stream tcp server &amp; client with 12.8k requests in single process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function tcp_pack(string $data): string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return pack('n', strlen($data)) . $data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function tcp_length(string $head): int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return unpack('n', $head)[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    go(function () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $ctx = stream_context_create(['socket' =&gt; ['so_reuseaddr' =&gt; true, 'backlog' =&gt; 128]]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $socket = stream_socket_server(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            'tcp://0.0.0.0:9502',</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $errno, $errstr, STREAM_SERVER_BIND | STREAM_SERVER_LISTEN, $ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!$socket) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            echo "$errstr ($errno)\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $i = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while ($conn = stream_socket_accept($socket, 1)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                stream_set_timeout($conn, 5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for ($n = 100; $n--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $data = fread($conn, tcp_length(fread($conn, 2)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    assert($data === "Hello Swoole Server #{$n}!");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fwrite($conn, tcp_pack("Hello Swoole Client #{$n}!"));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (++$i === 128) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fclose($socket);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for ($c = 128; $c--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go(function () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $fp = stream_socket_client("tcp://127.0.0.1:9502", $errno, $errstr, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$fp) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                echo "$errstr ($errno)\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                stream_set_timeout($fp, 5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for ($n = 100; $n--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fwrite($fp, tcp_pack("Hello Swoole Server #{$n}!"));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $data = fread($fp, tcp_length(fread($fp, 2)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    assert($data === "Hello Swoole Client #{$n}!");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fclose($fp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // udp server &amp; client with 12.8k requests in single process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    go(function () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $socket = new Swoole\Coroutine\Socket(AF_INET, SOCK_DGRAM, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $socket-&gt;bind('127.0.0.1', 9503);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $client_map = [];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for ($c = 128; $c--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for ($n = 0; $n &lt; 100; $n++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $recv = $socket-&gt;recvfrom($peer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $client_uid = "{$peer['address']}:{$peer['port']}";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $id = $client_map[$client_uid] = ($client_map[$client_uid] ?? -1) + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                assert($recv === "Client: Hello #{$id}!");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $socket-&gt;sendto($peer['address'], $peer['port'], "Server: Hello #{$id}!");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $socket-&gt;close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for ($c = 128; $c--;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        go(function () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $fp = stream_socket_client("udp://127.0.0.1:9503", $errno, $errstr, 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!$fp) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                echo "$errstr ($errno)\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for ($n = 0; $n &lt; 100; $n++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    fwrite($fp, "Client: Hello #{$n}!");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    $recv = fread($fp, 1024);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    list($address, $port) = explode(':', (stream_socket_get_name($fp, true)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    assert($address === '127.0.0.1' &amp;&amp; (int)$port === 9503);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    assert($recv === "Server: Hello #{$n}!");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fclose($fp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  echo 'use ' . (microtime(true) - $s) . ' s';</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="7channel">7.Channel<a class="hash-link" href="#7channel" title="Direct link to heading">​</a></h4><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"> Co\run(function(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //使用Channel进行协程间通讯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $chan = new Swoole\Coroutine\Channel(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Swoole\Coroutine::create(function () use ($chan) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for($i = 0; $i &lt; 100000; $i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                co::sleep(1.0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $chan-&gt;push(['rand' =&gt; rand(1000, 9999), 'index' =&gt; $i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                echo "$i\n";</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Swoole\Coroutine::create(function () use ($chan) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while(1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $data = $chan-&gt;pop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var_dump($data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  });</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3风格">3.风格<a class="hash-link" href="#3风格" title="Direct link to heading">​</a></h3><p><code>服务端</code> + <code>客户端</code></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="1异步风格">1.异步风格<a class="hash-link" href="#1异步风格" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithStickyNavbar_mojV" id="2协程风格">2.协程风格<a class="hash-link" href="#2协程风格" title="Direct link to heading">​</a></h4><p><code>进程</code>   ---&gt;  <code>线程</code>  ---&gt;   <code>协程</code>	</p><p> <code>连接池</code> (server的manager模块)</p><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Coroutine::create</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> 或 </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">go</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> 方法创建协程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">支持 </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">waitgroup</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 通信问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     进程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             高性能共享内存 </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Table</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Process</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token function" style="color:#d73a49">模块</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">代替php自带的 </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">pcntl</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   协程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Coroutine\Channel</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">并发编程</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Coroutine</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setdefer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   </span><span class="token function" style="color:#d73a49">go</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">退出协程</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">exit</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">禁用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">异常捕获</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">不能跨协程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">在多个协程间不能</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">共用</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">一个连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">禁止使用</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">静态类</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">或者</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">全局变量</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">保存上下文对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">sleep</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">不能用</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="4基本须知">4.基本须知<a class="hash-link" href="#4基本须知" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="1四种设置回调函数的方式">1.四种设置回调函数的方式<a class="hash-link" href="#1四种设置回调函数的方式" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 匿名函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$server</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Request'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">$req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $resp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">use</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">$a</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $b</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo </span><span class="token string" style="color:#e3116c">"hello world"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Copy</span><span class="token plain"> to clipboardErrorCopied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">可使用 use 向匿名函数传递参数</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 类静态方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">A</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">$req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $resp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo </span><span class="token string" style="color:#e3116c">"hello world"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$server</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Request'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'A::Test'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$server</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Request'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'A'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Test'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Copy</span><span class="token plain"> to clipboardErrorCopied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对应的静态方法必须为 </span><span class="token keyword" style="color:#00009f">public</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">my_onRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">$req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $resp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo </span><span class="token string" style="color:#e3116c">"hello world"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$server</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Request'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'my_onRequest'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 对象方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">A</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">$req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $resp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo </span><span class="token string" style="color:#e3116c">"hello world"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$object </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">A</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$server</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token function" style="color:#d73a49">on</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Request'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$object</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'test'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对应的方法必须为 </span><span class="token keyword" style="color:#00009f">public</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="2同步-io--异步-io">2.同步 IO / 异步 IO<a class="hash-link" href="#2同步-io--异步-io" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 网络io模型</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">同步模型（synchronous </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">阻塞</span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">（bloking </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">非阻塞</span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">（non</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">blocking </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">多路复用</span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">（multiplexing </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">） </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">poll/select</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">epoll</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">信号驱动式</span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">（signal</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">driven </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">异步</span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">（asynchronous </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain">）</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="3eventloop">3.EventLoop<a class="hash-link" href="#3eventloop" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">所谓 </span><span class="token maybe-class-name">EventLoop，即事件循环，可以简单的理解为</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">epoll_wait</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">，我们会把所有要发生事件的句柄（fd）加入到 epoll_wait 中，这些事件包括可读，可写，出错等。 我们的进程就阻塞在 epoll_wait </span><span class="token function" style="color:#d73a49">这个内核函数上，当发生了事件</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">或超时</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 后 epoll_wait 这个函数就会结束阻塞返回结果，就可以回调相应的 </span><span class="token constant" style="color:#36acaa">PHP</span><span class="token plain"> 函数，例如，收到客户端发来的数据，回调 </span><span class="token maybe-class-name">OnRecieve</span><span class="token plain"> 回调函数。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">当有大量的 fd 放入到了 epoll_wait 中，并且同时产生了大量的事件，epoll_wait 函数返回的时候我们就会挨个调用相应的回调函数，叫做一轮事件循环，即 </span><span class="token constant" style="color:#36acaa">IO</span><span class="token plain"> 多路复用，然后再次阻塞调用 epoll_wait 进行下一轮事件循环。</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="4tcp粘包问题">4.TCP粘包问题<a class="hash-link" href="#4tcp粘包问题" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">tcp 封包 解包 粘包 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">数据封包协议规定：整个数据包包含</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">字节长度信息</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">数据包体。</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">字节长度信息包含本身着</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">字节。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">如：数据体是（abcdefg）</span><span class="token number" style="color:#36acaa">7</span><span class="token plain">个字节，整体封包就是09abcdefg，总共是</span><span class="token number" style="color:#36acaa">9</span><span class="token plain">个字节的协议</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">EOF</span><span class="token plain"> 结束符协议</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">固定包头 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> 包体协议</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="5ipc">5.IPC<a class="hash-link" href="#5ipc" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">同一台主机上两个进程间通信</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Inter-Process Communication</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">在 </span><span class="token maybe-class-name">Swoole</span><span class="token plain"> 下使用了 </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">种方式</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># </span><span class="token maybe-class-name">Unix</span><span class="token plain"> </span><span class="token maybe-class-name">Socket</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">全名 </span><span class="token constant" style="color:#36acaa">UNIX</span><span class="token plain"> </span><span class="token maybe-class-name">Domain</span><span class="token plain"> </span><span class="token maybe-class-name">Socket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 简称 </span><span class="token constant" style="color:#36acaa">UDS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">SOCK_STREAM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">数据大用</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">有粘包问题</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">SOCK_DGRAM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">数据小用</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">64k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># sysvmsg </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Linux</span><span class="token plain"> 提供的消息队列，这种 </span><span class="token constant" style="color:#36acaa">IPC</span><span class="token plain"> 方式通过一个文件名来作为 key 进行通讯，这种方式非常的不灵活，实际项目使用的并不多</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="5安装">5.安装<a class="hash-link" href="#5安装" title="Direct link to heading">​</a></h3><p><code>扩展冲突</code></p><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">xdebug</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">phptrace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">molten</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xhprof</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">phalcon（Swoole 协程无法运行在 phalcon 框架中）</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>必须</code></p><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">php</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">7.1</span><span class="token plain"> 或更高版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcc</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4.8</span><span class="token plain"> 或更高版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">autoconf</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="1源码安装">1.源码安装<a class="hash-link" href="#1源码安装" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">1.</span><span class="token plain"> 下载 swoole 源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoole</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoole</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">src</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">releases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pecl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">net</span><span class="token operator" style="color:#393A34">/</span><span class="token keyword" style="color:#00009f">package</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">git</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">oschina</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">net</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoole</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">2.</span><span class="token plain"> 从源码编译安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">下载源代码包后，在终端进入源码目录，执行下面的命令进行编译和安装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd swoole</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">src </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">phpize </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">configure </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">enable</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">openssl  \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">enable</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">http2 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> sudo make install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><span class="token number" style="color:#36acaa">3.</span><span class="token plain"> 启用扩展</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">编译安装到系统成功后，需要在 php</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ini</span><span class="token plain"> 中加入一行 extension</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">swoole</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">so</span><span class="token plain"> 来启用 </span><span class="token maybe-class-name">Swoole</span><span class="token plain"> 扩展</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="2pecl安装">2.pecl安装<a class="hash-link" href="#2pecl安装" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">pecl install swoole</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="3swoft">3.swoft<a class="hash-link" href="#3swoft" title="Direct link to heading">​</a></h2><p><code>version:2.x</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1环境准备">1.环境准备<a class="hash-link" href="#1环境准备" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">#必要部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PHP</span><span class="token plain">，版本 </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">7.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PHP</span><span class="token plain"> 包管理器 </span><span class="token maybe-class-name">Composer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PCRE</span><span class="token plain"> 库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">PHP</span><span class="token plain"> 扩展 </span><span class="token maybe-class-name">Swoole，版本</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">4.3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">额外扩展：</span><span class="token constant" style="color:#36acaa">PDO</span><span class="token plain">、Redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#冲突部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Xdebug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Xhprof</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Blackfire</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Zend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Uopz</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="2安装方式">2.安装方式<a class="hash-link" href="#2安装方式" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_mojV" id="1docker">1.docker<a class="hash-link" href="#1docker" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">docker run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">p </span><span class="token number" style="color:#36acaa">18306</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">18306</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">name swoft swoft</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="2docker-compose">2.docker-compose<a class="hash-link" href="#2docker-compose" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cloud</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd swoft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compose up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># sserver下面有以下文件配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">compose</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">sync </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> rsync </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> native_osx</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="3composer">3.composer<a class="hash-link" href="#3composer" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">composer create</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">project swoft</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft </span><span class="token maybe-class-name">Swoft</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="4手动安装">4.手动安装<a class="hash-link" href="#4手动安装" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">cloud</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd swoft</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">composer install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">example</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">env</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="5swoftcli">5.swoftcli<a class="hash-link" href="#5swoftcli" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 支持从不同模板项目中快速创建一个干净的 </span><span class="token maybe-class-name">Swoft</span><span class="token plain"> 应用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">php swoftcli</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">phar</span><span class="token plain"> create</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">app </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">type full </span><span class="token maybe-class-name">Swoft</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">Full</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">php swoftcli</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">phar</span><span class="token plain"> create</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">app </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">type ws </span><span class="token maybe-class-name">Swoft</span><span class="token operator" style="color:#393A34">-</span><span class="token maybe-class-name">WebSocket</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">php swoftcli</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">phar</span><span class="token plain"> create</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">app </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">type tcp </span><span class="token maybe-class-name">Swoft</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp swoftcli</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">phar</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">usr</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">local</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoftcli </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> chmod a</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">x swoftcli</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="3目录结构">3.目录结构<a class="hash-link" href="#3目录结构" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">├── app</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 应用代码目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Annotation</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">定义注解相关</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">ReflectionCalss</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Aspect</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AOP</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">切面</span><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">Aspect-oriented programming</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Common</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 一些具有独立功能的 </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Console</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 命令行代码目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Exception</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 定义异常类目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── </span><span class="token maybe-class-name">Handler</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 定义异常处理类目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Http</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">              </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 服务代码目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── </span><span class="token maybe-class-name">Controller</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── </span><span class="token maybe-class-name">Middleware</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Helper</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">            </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 助手函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Listener</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">          </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 事件监听器目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Model</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">             </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">模型、逻辑等代码目录</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">这些层并不限定，根据需要使用</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── </span><span class="token maybe-class-name">Dao</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── </span><span class="token maybe-class-name">Data</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── </span><span class="token maybe-class-name">Logic</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── </span><span class="token maybe-class-name">Entity</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RPC</span><span class="token plain"> 服务代码目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── </span><span class="token maybe-class-name">Service</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── </span><span class="token maybe-class-name">Middleware</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">WebSocket</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token maybe-class-name">WebSocket</span><span class="token plain"> 服务代码目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── </span><span class="token maybe-class-name">Chat</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── </span><span class="token maybe-class-name">Middleware</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── </span><span class="token maybe-class-name">ChatModule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Tcp</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"> 服务代码目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── </span><span class="token maybe-class-name">Controller</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">TCP</span><span class="token plain"> 服务处理控制器目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">Application</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain">    </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 应用类文件继承自swoft核心</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── </span><span class="token maybe-class-name">AutoLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">项目扫描等信息</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">应用本身也算是一个组件</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── bean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── bootstrap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── swoft              </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token maybe-class-name">Swoft</span><span class="token plain"> 入口文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">                </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 应用配置目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── base</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 基础配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain">                 </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 数据库配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── </span><span class="token keyword" style="color:#00009f">public</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">                </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 公共目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── resource</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">              </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 应用资源目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── language</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">              </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 语言资源目录  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── view</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">                  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 视图资源目录  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── runtime</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 临时文件目录（日志、上传文件、文件缓存等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── test</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">                  </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 单元测试目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── bootstrap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── composer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── phar</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">build</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">inc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── phpunit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">xml</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">dist</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="4运行服务">4.运行服务<a class="hash-link" href="#4运行服务" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">如果在 </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">env</span><span class="token plain"> 文件中开启了调试 </span><span class="token constant" style="color:#36acaa">SWOFT_DEBUG</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> 将会在控制台中显示更多详细的信息。</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="1http-server-1">1.http server<a class="hash-link" href="#1http-server-1" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动 </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft http</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 以守护进程模式启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft http</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启 </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft http</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重新加载 </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft http</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 停止 </span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft http</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># swoftcli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">swoftcli </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">swoftcli run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c ws</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">swoftcli run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c http</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="2websocket-server-1">2.websocket server<a class="hash-link" href="#2websocket-server-1" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动 </span><span class="token constant" style="color:#36acaa">WS</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft ws</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 以守护进程模式启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft ws</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启 </span><span class="token constant" style="color:#36acaa">WS</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft ws</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重新加载 </span><span class="token constant" style="color:#36acaa">WS</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft ws</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 关闭 </span><span class="token constant" style="color:#36acaa">WS</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft ws</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">stop</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="3rpc-server">3.rpc server<a class="hash-link" href="#3rpc-server" title="Direct link to heading">​</a></h4><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 启动 </span><span class="token constant" style="color:#36acaa">RPC</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft rpc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 以守护进程模式启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft rpc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">start </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重启 </span><span class="token constant" style="color:#36acaa">RPC</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft rpc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">restart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 重新加载 </span><span class="token constant" style="color:#36acaa">RPC</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft rpc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 关闭 </span><span class="token constant" style="color:#36acaa">RPC</span><span class="token plain"> 服务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ php </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">swoft rpc</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">stop</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="5注解">5.注解<a class="hash-link" href="#5注解" title="Direct link to heading">​</a></h3><div class="language-php codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-php codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">use Swoft\Http\Message\Request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Swoft\Http\Server\Annotation\Mapping\Controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use Swoft\Http\Server\Annotation\Mapping\RequestMapping;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Class Home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @Controller(prefix="home")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 该方法路由地址为 /home/index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @RequestMapping(route="/index", method="post")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param Request $request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function index(Request $request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // TODO:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="6ioc---di">6.IoC - DI<a class="hash-link" href="#6ioc---di" title="Direct link to heading">​</a></h3><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token literal-property property" style="color:#36acaa">IoC</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Inversion</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"> </span><span class="token maybe-class-name">Control</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">DI</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dependency</span><span class="token plain"> </span><span class="token maybe-class-name">Injection</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Bean容器</code></p><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 定义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@</span><span class="token maybe-class-name">Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命名空间：\</span><span class="token maybe-class-name">Swoft</span><span class="token plain">\</span><span class="token maybe-class-name">Bean</span><span class="token plain">\</span><span class="token maybe-class-name">Annotation</span><span class="token plain">\</span><span class="token maybe-class-name">Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name 定义 </span><span class="token maybe-class-name">Bean</span><span class="token plain"> 别名，缺省默认类名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scope 注入 </span><span class="token maybe-class-name">Bean</span><span class="token plain"> 类型，默认单例，Scope</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token constant" style="color:#36acaa">SINGLETON</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Scope</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token constant" style="color:#36acaa">PROTOTYPE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">每次创建</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ref 指定引用 </span><span class="token maybe-class-name">Bean</span><span class="token plain"> ，用于定义在接口上面，指定使用哪个接口实现。</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 注入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@</span><span class="token maybe-class-name">Inject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">命名空间：\</span><span class="token maybe-class-name">Swoft</span><span class="token plain">\</span><span class="token maybe-class-name">Bean</span><span class="token plain">\</span><span class="token maybe-class-name">Annotation</span><span class="token plain">\</span><span class="token maybe-class-name">Inject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name 定义属性注入的bean名称，缺省属性自动类型名称</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-js codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain"># 操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">App</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">getBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">ApplicationContext</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">getBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'name'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">BeanFactory</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">getBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'name'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">BeanFactory</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">:</span><span class="token function" style="color:#d73a49">hasBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>php</category>
            <category>websocket</category>
            <category>tcp</category>
        </item>
        <item>
            <title><![CDATA[Second Blog Post]]></title>
            <link>https://sado0823.github.io/blog/second-blog-post</link>
            <guid>second-blog-post</guid>
            <pubDate>Tue, 24 May 2022 18:30:00 GMT</pubDate>
            <description><![CDATA[2nd coming soon]]></description>
            <content:encoded><![CDATA[<p>2nd coming soon</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="1-title1">1 title1<a class="hash-link" href="#1-title1" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_mojV" id="2-title2">2 title2<a class="hash-link" href="#2-title2" title="Direct link to heading">​</a></h2>]]></content:encoded>
            <category>golang</category>
            <category>grpc</category>
        </item>
        <item>
            <title><![CDATA[First Blog Post]]></title>
            <link>https://sado0823.github.io/blog/first-blog-post</link>
            <guid>first-blog-post</guid>
            <pubDate>Tue, 24 May 2022 18:00:00 GMT</pubDate>
            <description><![CDATA[1st coming soon]]></description>
            <content:encoded><![CDATA[<p>1st coming soon</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="1-title1">1 title1<a class="hash-link" href="#1-title1" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_mojV" id="2-title2">2 title2<a class="hash-link" href="#2-title2" title="Direct link to heading">​</a></h2>]]></content:encoded>
            <category>golang</category>
            <category>grpc</category>
        </item>
    </channel>
</rss>