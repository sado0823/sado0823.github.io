"use strict";(self.webpackChunkgo_kitx_webside=self.webpackChunkgo_kitx_webside||[]).push([[775],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return g}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=a.createContext({}),p=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(c.Provider,{value:n},e.children)},s={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=p(t),g=r,m=d["".concat(c,".").concat(g)]||d[g]||s[g]||i;return t?a.createElement(m,l(l({ref:n},u),{},{components:t})):a.createElement(m,l({ref:n},u))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=d;var o={};for(var c in n)hasOwnProperty.call(n,c)&&(o[c]=n[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=t[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},7276:function(e,n,t){t.r(n),t.d(n,{assets:function(){return u},contentTitle:function(){return c},default:function(){return g},frontMatter:function(){return o},metadata:function(){return p},toc:function(){return s}});var a=t(7462),r=t(3366),i=(t(7294),t(3905)),l=["components"],o={sidebar_position:3,id:"grpc_p2c",title:"P2C Balancer"},c="grpc p2c balancer",p={unversionedId:"grpc/grpc_p2c",id:"grpc/grpc_p2c",title:"P2C Balancer",description:"https://github.com/sado0823/go-kitx/blob/master/grpc/balancer/p2c/p2c.go",source:"@site/docs/grpc/p2c.md",sourceDirName:"grpc",slug:"/grpc/grpc_p2c",permalink:"/docs/grpc/grpc_p2c",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/grpc/p2c.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,id:"grpc_p2c",title:"P2C Balancer"},sidebar:"tutorialSidebar",previous:{title:"GRPC",permalink:"/docs/category/grpc"},next:{title:"KIT",permalink:"/docs/category/kit"}},u={},s=[{value:"\u57fa\u672c\u601d\u60f3",id:"\u57fa\u672c\u601d\u60f3",level:2},{value:"EWMA",id:"ewma",level:4},{value:"\u725b\u987f\u51b7\u5374\u5b9a\u5f8b\u8870\u51cf\u6a21\u578b",id:"\u725b\u987f\u51b7\u5374\u5b9a\u5f8b\u8870\u51cf\u6a21\u578b",level:4},{value:"\u57fa\u672c\u6d41\u7a0b",id:"\u57fa\u672c\u6d41\u7a0b",level:2},{value:"\u6e90\u7801\u5206\u6790",id:"\u6e90\u7801\u5206\u6790",level:2},{value:"roundrobin",id:"roundrobin",level:4},{value:"p2c",id:"p2c",level:4},{value:"\u63a5\u53e3",id:"\u63a5\u53e3",level:5},{value:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784",id:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784",level:5},{value:"load\u8d1f\u8f7d\u8ba1\u7b97",id:"load\u8d1f\u8f7d\u8ba1\u7b97",level:5},{value:"Pick\u8fc7\u7a0b",id:"pick\u8fc7\u7a0b",level:5},{value:"\u8bf7\u6c42\u7ed3\u675f, \u66f4\u65b0\u8282\u70b9\u4fe1\u606f",id:"\u8bf7\u6c42\u7ed3\u675f-\u66f4\u65b0\u8282\u70b9\u4fe1\u606f",level:5}],d={toc:s};function g(e){var n=e.components,o=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},d,o,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"grpc-p2c-balancer"},"grpc p2c balancer"),(0,i.kt)("h1",{id:"\u9879\u76ee\u5730\u5740"},"\u9879\u76ee\u5730\u5740:"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/sado0823/go-kitx/blob/master/grpc/balancer/p2c/p2c.go"},"https://github.com/sado0823/go-kitx/blob/master/grpc/balancer/p2c/p2c.go")),(0,i.kt)("h1",{id:"what"},"what?"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"P2C"),"\u7b97\u6cd5\u5168\u79f0",(0,i.kt)("inlineCode",{parentName:"p"},"pick of 2 choices"),"\uff0c\u76f8\u6bd4",(0,i.kt)("inlineCode",{parentName:"p"},"WRR(\u52a0\u6743\u8f6e\u8be2\u7b97\u6cd5)"),"\uff0cP2C\u968f\u673a\u9009\u62e9\u4e24\u4e2a\u8282\u70b9\u540e\u5728\u8fd9\u4fe9\u8282\u70b9\u91cc\u9009\u62e9\u4f18\u80dc\u8005\uff0c\u5e76\u901a\u8fc7",(0,i.kt)("inlineCode",{parentName:"p"},"\u6307\u6570\u52a0\u6743\u79fb\u52a8\u5e73\u5747\u7b97\u6cd5"),"\u7edf\u8ba1\u670d\u52a1\u7aef\u7684\u5b9e\u65f6\u72b6\u6001\uff0c\u4ece\u800c\u505a\u51fa\u6700\u4f18\u9009\u62e9\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"p2c (Pick Of 2 Choices)")," \u4e8c\u9009\u4e00: \u5728\u591a\u4e2a\u8282\u70b9\u4e2d\u968f\u673a\u9009\u62e9\u4e24\u4e2a\u8282\u70b9\u3002")),(0,i.kt)("p",null,"\u9009\u62e9\u4e24\u4e2a\u7b26\u5408\u5065\u5eb7\u5ea6\u7684\u8282\u70b9\u8fdb\u884c\u8ba1\u7b97\u8d1f\u8f7d, \u4f18\u5148\u9009\u62e9\u51fa\u7b26\u5408\u6807\u51c6\u7684\u8282\u70b9, \u8fd9\u91cc\u8ba1\u7b97\u8d1f\u8f7d\u6709\u8fd0\u7528",(0,i.kt)("inlineCode",{parentName:"p"},"cpu"),"\u7684\u65b9\u5f0f\u548c",(0,i.kt)("inlineCode",{parentName:"p"},"\u8ba1\u7b97\u5ef6\u8fdf(lag)+\u8282\u70b9\u62e5\u585e\u5ea6(inflight)"),"\u7684\u65b9\u5f0f"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EWMA (Exponentially Weighted Moving-Average)")," \u6307\u6570\u52a0\u6743\u5e73\u5747\u7b97\u6cd5\u516c\u5f0f: ",(0,i.kt)("inlineCode",{parentName:"li"},"vt = vt-1 * \u03b2 + vt * (1 - \u03b2)"))),(0,i.kt)("p",null,"\u8fd9\u4e2a\u7b97\u6cd5\u4e4b\u524d\u6211\u4eec\u5728\u81ea\u9002\u5e94\u9650\u6d41",(0,i.kt)("inlineCode",{parentName:"p"},"bbr"),"\u7b97\u6cd5\u4e2d\u4e5f\u6709\u7528\u5230, \u4e3b\u8981\u7528\u4e8e\u8ba1\u7b97cpu\u8d1f\u8f7d, \u4f18\u52bf\u4e3a\u80fd\u591f\u51cf\u5c0f\u5c16\u523a(\u7f51\u7edc\u6ce2\u52a8)\u7684\u5f71\u54cd"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"vt"),":\u5f53\u524d\u503c"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"vt-1"),": \u4e0a\u4e00\u5468\u671f\u503c"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"\u03b2"),":\u5e38\u91cf"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u725b\u987f\u51b7\u5374\u5b9a\u5f8b\u8870\u51cf\u6a21\u578b: ",(0,i.kt)("inlineCode",{parentName:"li"},"\u03b2 = 1/e^(k*\u25b3t)"))),(0,i.kt)("p",null,"\u8fd0\u7528\u8fd9\u4e2a\u6a21\u578b\u5c31\u8981\u7528\u4e8e\u8ba1\u7b97EWMA\u4e2d\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"\u03b2"),"\u503c"),(0,i.kt)("h1",{id:"why"},"why?"),(0,i.kt)("p",null,"\u4e00\u822c\u7684\u4f7f\u7528\u573a\u666f\u662f:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u5c3d\u91cf\u9009\u62e9",(0,i.kt)("inlineCode",{parentName:"li"},"\u8d1f\u8f7d\u6700\u4f4e"),"\u7684\u8282\u70b9"),(0,i.kt)("li",{parentName:"ul"},"\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u5c3d\u91cf\u9009\u62e9",(0,i.kt)("inlineCode",{parentName:"li"},"\u5ef6\u8fdf\u6700\u4f4e"),"\u7684\u8282\u70b9"),(0,i.kt)("li",{parentName:"ul"},"\u9694\u79bb\u6545\u969c\u8282\u70b9, \u81ea\u52a8\u6458\u6d41"),(0,i.kt)("li",{parentName:"ul"},"\u6545\u969c\u8282\u70b9\u6062\u590d\u540e\u81ea\u52a8, \u81ea\u52a8\u63a5\u6d41"),(0,i.kt)("li",{parentName:"ul"},"\u5224\u65ad\u662f\u5426\u5b58\u5728\u67d0\u884c\u6570\u636e,\u7528\u4ee5\u51cf\u5c11\u5bf9\u78c1\u76d8\u8bbf\u95ee\uff0c\u63d0\u9ad8\u670d\u52a1\u7684\u8bbf\u95ee\u6027\u80fd")),(0,i.kt)("h1",{id:"how"},"how?"),(0,i.kt)("h2",{id:"\u57fa\u672c\u601d\u60f3"},"\u57fa\u672c\u601d\u60f3"),(0,i.kt)("h4",{id:"ewma"},"EWMA"),(0,i.kt)("p",null,"EWMA\u4e3b\u8981\u7528\u4e8e\u4e0e\u4e00\u822c\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"\u7b97\u6570\u5e73\u5747\u6570"),"\u4f5c\u5bf9\u6bd4, \u8ba1\u7b97\u516c\u5f0f\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"vt = vt-1 * \u03b2 + vt * (1 - \u03b2)")),(0,i.kt)("p",null,"\u6211\u4eec\u7528\u4e00\u5468\u7684",(0,i.kt)("inlineCode",{parentName:"p"},"\u6e29\u5ea6"),"\u8ba1\u7b97\u6765\u505a\u6bd4\u8f83, ewma\u4e2d\u03b2\u503c\u4e00\u822c\u5728\u4e8e(0-1)\u4e4b\u95f4, \u8fd9\u91cc\u9009\u53d610% = 0.1"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image-20220412003955372",src:t(6367).Z,width:"1550",height:"532"})),(0,i.kt)("p",null,"\u4e00\u5468\u7684\u8d8b\u52bf\u56fe\u5982\u4e0b"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image-20220412004052835",src:t(2502).Z,width:"1666",height:"642"})),(0,i.kt)("p",null,"\u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u51fa, \u4f7f\u7528ewma\u80fd\u591f\u4f7f\u5f97\u66f2\u7ebf\u975e\u5e38\u7684\u5e73\u6ed1, \u4ece\u800c\u51cf\u7f13\u4e00\u4e9b\u5c16\u523a\u884c\u4e3a, ",(0,i.kt)("inlineCode",{parentName:"p"},"\u03b2\u8d8a\u5927\u8d8a\u63a5\u8fd1\u5e73\u5747\u503c"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"\u03b2\u8d8a\u5c0f\u8d8a\u63a5\u8fd1\u539f\u503c"),"."),(0,i.kt)("p",null,"\u6709\u4e00\u4e2a\u4e00\u822c\u7528\u7684\u8ba1\u7b97",(0,i.kt)("inlineCode",{parentName:"p"},"\u03b2"),"\u516c\u5f0f\u4e3a: ",(0,i.kt)("inlineCode",{parentName:"p"},"2/(n+1)")),(0,i.kt)("h4",{id:"\u725b\u987f\u51b7\u5374\u5b9a\u5f8b\u8870\u51cf\u6a21\u578b"},"\u725b\u987f\u51b7\u5374\u5b9a\u5f8b\u8870\u51cf\u6a21\u578b"),(0,i.kt)("p",null,"\u516c\u5f0f: ",(0,i.kt)("inlineCode",{parentName:"p"},"\u03b2 = 1/e^(k*\u25b3t)"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"e"),"\u662f\u6570\u5b66\u5e38\u6570, ",(0,i.kt)("inlineCode",{parentName:"p"},"\u25b3t"),"\u4e3a\u7b2ct\u6b21\u7684\u8bf7\u6c42\u5ef6\u8fdf, ",(0,i.kt)("inlineCode",{parentName:"p"},"k"),"\u8868\u793a\u8870\u51cf\u7cfb\u6570 (\u4ee3\u7801\u4e2d\u5b9e\u73b0\u4e3a10s)"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image-20220412010038364",src:t(9092).Z,width:"1322",height:"814"})),(0,i.kt)("p",null,"\u8bbe ",(0,i.kt)("inlineCode",{parentName:"p"},"x = k * \u25b3t"),", \u5219\u516c\u5f0f\u4e3a",(0,i.kt)("inlineCode",{parentName:"p"},"f(x) = 1/e^x"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"x\u8d8a\u5927, y\u8d8a\u5c0f"),", \u4e5f\u5c31\u662f\u8bf4"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"\u25b3t"),"\u5ef6\u8fdf\u8d8a\u9ad8, ",(0,i.kt)("inlineCode",{parentName:"li"},"\u03b2"),"\u8d8a\u5c0f, ewma\u4e2d",(0,i.kt)("inlineCode",{parentName:"li"},"\u03b2"),"\u8d8a\u5c0f, \u5219\u8d8a\u63a5\u8fd1\u539f\u503c, \u5ef6\u8fdf\u9ad8\u7684\u60c5\u51b5\u4e0b\u51f8\u663e\u51fa\u539f\u59cb\u5ef6\u8fdf, \u80fd\u591f\u68c0\u6d4b\u5230\u7f51\u7edc\u6bdb\u523a"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"\u25b3t"),"\u5ef6\u8fdf\u8d8a\u4f4e, ",(0,i.kt)("inlineCode",{parentName:"li"},"\u03b2"),"\u8d8a\u5927, ewma\u4e2d",(0,i.kt)("inlineCode",{parentName:"li"},"\u03b2"),"\u8d8a\u5927, \u5219\u8d8a\u63a5\u8fd1\u5e73\u5747\u503c")),(0,i.kt)("h2",{id:"\u57fa\u672c\u6d41\u7a0b"},"\u57fa\u672c\u6d41\u7a0b"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"image-20220412101142089",src:t(1866).Z,width:"2158",height:"1156"})),(0,i.kt)("h2",{id:"\u6e90\u7801\u5206\u6790"},"\u6e90\u7801\u5206\u6790"),(0,i.kt)("h4",{id:"roundrobin"},"roundrobin"),(0,i.kt)("p",null,"\u5148\u770b",(0,i.kt)("inlineCode",{parentName:"p"},"google grpc roundrobin"),"\u5185\u90e8\u5b9e\u73b0 ",(0,i.kt)("inlineCode",{parentName:"p"},"https://github.com/grpc/grpc-go/blob/master/balancer/roundrobin/roundrobin.go")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'package roundrobin\n\nimport (\n    "sync"\n\n    "google.golang.org/grpc/balancer"\n    "google.golang.org/grpc/balancer/base"\n    "google.golang.org/grpc/grpclog"\n    "google.golang.org/grpc/internal/grpcrand"\n)\n\n// Name is the name of round_robin balancer.\nconst Name = "round_robin"\n\nvar logger = grpclog.Component("roundrobin")\n\n// newBuilder creates a new roundrobin balancer builder.\nfunc newBuilder() balancer.Builder {\n    return base.NewBalancerBuilder(Name, &rrPickerBuilder{}, base.Config{HealthCheck: true})\n}\n\nfunc init() {\n    balancer.Register(newBuilder())\n}\n\ntype rrPickerBuilder struct{}\n\nfunc (*rrPickerBuilder) Build(info base.PickerBuildInfo) balancer.Picker {\n    ...\n}\n\ntype rrPicker struct {\n}\n\nfunc (p *rrPicker) Pick(balancer.PickInfo) (balancer.PickResult, error) {\n    ...\n}\n')),(0,i.kt)("p",null,"\u4ee5\u4e0a\u4ee3\u7801\u7701\u53bb\u4e86\u5173\u952e\u5b9e\u73b0, \u53ef\u4ee5\u770b\u51fa, \u8981\u5b9e\u73b0\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5, \u53ea\u8981\u9700\u8981\u5b9e\u73b0\u5185\u90e8\u7684\u4e24\u4e2a",(0,i.kt)("inlineCode",{parentName:"p"},"interface")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// 1. \u6709\u8282\u70b9\u66f4\u65b0\u4f1a\u8c03\u7528build\u65b9\u6cd5\ntype PickerBuilder interface {\n    Build(info PickerBuildInfo) balancer.Picker\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// 2. \u6311\u9009\u8282\u70b9\ntype Picker interface {\n    Pick(info PickInfo) (PickResult, error)\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// 3. \u6ce8\u518c\u8d1f\u8f7d\u5747\u8861\u5668\nfunc init() {\n    balancer.Register(newBuilder())\n}\n")),(0,i.kt)("h4",{id:"p2c"},"p2c"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"https://github.com/sado0823/go-kitx/blob/master/grpc/balancer/p2c/p2c.go")),(0,i.kt)("h5",{id:"\u63a5\u53e3"},"\u63a5\u53e3"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// \u5b9e\u73b0 PickerBuilder \u63a5\u53e3\ntype p2cPickBuilder struct {\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// \u5b9e\u73b0 Picker \u63a5\u53e3\ntype p2cPicker struct {\n    conns []*subConn\n    r     *rand.Rand\n    stamp *atomicx.AtomicDuration\n    lock  sync.Mutex\n}\n")),(0,i.kt)("h5",{id:"\u6838\u5fc3\u6570\u636e\u7ed3\u6784"},"\u6838\u5fc3\u6570\u636e\u7ed3\u6784"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type p2cSubConn struct {\n    addr resolver.Address\n    conn balancer.SubConn\n\n    lagEWMA uint64  // \u8bf7\u6c42\u8017\u65f6, \u8ba1\u7b97\u540e\u7684ewma\n\n    inFlight int64  // \u8282\u70b9\u62e5\u585e\u5ea6, \u6b63\u5728\u5904\u7406\u7684\u8bf7\u6c42\n    successEWMA  uint64 // \u8bf7\u6c42\u6210\u529f\u6570\u91cf\n    requests int64  // \u8bf7\u6c42\u91cf\n\n    lastLag int64   // \u4e0a\u4e00\u6b21\u8bf7\u6c42\u8017\u65f6, \u7528\u4e8e\u8ba1\u7b97ewma\n    pickTime int64  // \u4e0a\u4e00\u6b21\u9009\u62e9\u7684\u65f6\u95f4\u65f6\u95f4\u6233\n}\n")),(0,i.kt)("p",null,"\u5728\u6b64\u57fa\u7840\u4e0a, \u8fd8\u53ef\u4ee5\u518d\u52a0\u4e0a",(0,i.kt)("inlineCode",{parentName:"p"},"weight"),"\u5b57\u6bb5, \u8bbe\u7f6e\u6743\u91cd"),(0,i.kt)("h5",{id:"load\u8d1f\u8f7d\u8ba1\u7b97"},"load\u8d1f\u8f7d\u8ba1\u7b97"),(0,i.kt)("p",null,"\u6709\u4e24\u79cd\u65b9\u5f0f:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"load = lagEWMA * inFlight"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"lagEWMA")," \u76f8\u5f53\u4e8e\u5e73\u5747\u8bf7\u6c42\u8017\u65f6\uff0c",(0,i.kt)("inlineCode",{parentName:"li"},"inFlight")," \u662f\u5f53\u524d\u8282\u70b9\u6b63\u5728\u5904\u7406\u8bf7\u6c42\u7684\u6570\u91cf\uff0c\u76f8\u4e58\u5927\u81f4\u8ba1\u7b97\u51fa\u4e86\u5f53\u524d\u8282\u70b9\u7684\u7f51\u7edc\u8d1f\u8f7d, \u6211\u4eec\u91c7\u7528\u7684\u5c31\u662f\u8fd9\u79cd\u65b9\u5f0f"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"oad = cpuEWMA * lag * inFlight"),":  ",(0,i.kt)("inlineCode",{parentName:"li"},"cpuEWMA")," \u5229\u7528\u670d\u52a1\u7aef\u7684cpu\u503c\u8ba1\u7b97\u8d1f\u8f7d, \u53ef\u4ee5\u4ece",(0,i.kt)("inlineCode",{parentName:"li"},"balancer.DoneInfo. Trailer"),"\u4e2d\u4ece\u670d\u52a1\u7aef\u4f20\u9012, \u5b9e\u9645\u4e3a",(0,i.kt)("inlineCode",{parentName:"li"},"metadata.MD"),"\u7c7b\u578b, ",(0,i.kt)("inlineCode",{parentName:"li"},"map[string][]string"),"\u7684\u522b\u540d")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"// load = lagEWMA * inFlight\nfunc (s *p2cSubConn) load() int64 {\n    lag := int64(math.Sqrt(float64(atomic.LoadUint64(&s.lagEWMA) + 1)))\n    load := lag * (atomic.LoadInt64(&s.inFlight) + 1)\n    if load == 0 {\n        // penalty\u662f\u521d\u59cb\u5316\u6ca1\u6709\u6570\u636e\u65f6\u7684\u60e9\u7f5a\u503c, \u5728\u6ca1\u6709\u88ab\u9009\u8fc7\u7684\u60c5\u51b5\u4e0b, \u4f1a\u5f3a\u5236\u9009\u62e9\u4e00\u6b21\n        return penalty\n    }\n\n    return load\n}\n")),(0,i.kt)("h5",{id:"pick\u8fc7\u7a0b"},"Pick\u8fc7\u7a0b"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"    var chosen *p2cSubConn\n    switch len(p.conns) {\n    case 0: // \u6ca1\u6709\u8282\u70b9, \u76f4\u63a5\u62a5\u9519\n        return balancer.PickResult{}, balancer.ErrNoSubConnAvailable\n    case 1: // \u4e00\u4e2a\u8282\u70b9, \u76f4\u63a5\u8fd4\u56de\n        chosen = p.choose(p.conns[0], nil)\n    case 2: // \u4e24\u4e2a\u8282\u70b9, \u8fd4\u56de\u8d1f\u8f7d\u6700\u4f4e\u7684\u8282\u70b9\n        chosen = p.choose(p.conns[0], p.conns[1])\n    default: // \u591a\u4e2a\u8282\u70b9, \u6700\u591a\u7ecf\u5e38\u4e09\u6b21\u8ba1\u7b97, \u9009\u62e9\u5408\u9002\u7684\u8282\u70b9\n        var node1, node2 *p2cSubConn\n        // \u4e09\u6b21\u968f\u673a\u9009\u62e9\u8282\u70b9\n        for i := 0; i < pickTimes; i++ {\n            a := p.r.Intn(len(p.conns))\n            b := p.r.Intn(len(p.conns) - 1)\n            if b >= a {\n                // \u9632\u6b62\u51fa\u73b0\u76f8\u540c\u8282\u70b9\n                b++\n            }\n            node1 = p.conns[a]\n            node2 = p.conns[b]\n\n            // \u9009\u51fa\u4e00\u6b21\u7b26\u5408\u8981\u6c42\u7684\u8282\u70b9\u5219\u505c\u6b62\n            if node1.healthy() && node2.healthy() {\n                break\n            }\n        }\n\n        chosen = p.choose(node1, node2)\n    }\n")),(0,i.kt)("h5",{id:"\u8bf7\u6c42\u7ed3\u675f-\u66f4\u65b0\u8282\u70b9\u4fe1\u606f"},"\u8bf7\u6c42\u7ed3\u675f, \u66f4\u65b0\u8282\u70b9\u4fe1\u606f"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"        // \u6b63\u5728\u5904\u7406\u7684\u8bf7\u6c42\u6570-1\n        atomic.AddInt64(&c.inFlight, -1)\n\n        // \u8ba1\u7b97\u76f8\u5bf9\u65f6\u95f4\n        now := time.Since(initTime)\n        last := atomic.SwapInt64(&c.lastLag, int64(now))\n        td := int64(now) - last\n        if td < 0 {\n            td = 0\n        }\n\n        // \u725b\u987f\u51b7\u5374\u5b9a\u5f8b\u7684\u8870\u51cf\u6a21\u578b, \u786e\u5b9aewma\u4e2d\u7684\u03b2\u503c, \u03b2 = 1/e^(k*\u25b3t)\n        beta := math.Exp(float64(-td) / float64(decayTime))\n        lag := int64(now) - start\n        if lag < 0 {\n            lag = 0\n        }\n        olag := atomic.LoadUint64(&c.lagEWMA)\n        if olag == 0 {\n            beta = 0\n        }\n\n        // \u6307\u6570\u52a0\u6743\u5e73\u5747\u7b97\u6cd5 vt = vt-1 * \u03b2 + vt * (1 - \u03b2)\n        // \u5b58\u50a8\u5f53\u524dlagEWMA\n        atomic.StoreUint64(&c.lagEWMA, uint64(float64(olag)*beta+float64(lag)*(1-beta)))\n\n        success := initSuccess\n        if info.Err != nil {\n            switch status.Code(info.Err) {\n            case codes.DeadlineExceeded, codes.Internal, codes.Unavailable, codes.DataLoss:\n                success = 0\n            }\n        }\n\n        oldSuccess := atomic.LoadUint64(&c.successEWMA)\n        // \u6307\u6570\u52a0\u6743\u5e73\u5747\u7b97\u6cd5 vt = vt-1 * \u03b2 + vt * (1 - \u03b2)\n        // \u5b58\u50a8\u5f53\u524dsuccessEWMA\n        atomic.StoreUint64(&c.successEWMA, uint64(float64(oldSuccess)*beta+float64(success)*(1-beta)))\n")),(0,i.kt)("h1",{id:"example"},"example"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func test() {\n    cc, err := grpc.Dial(r.Scheme()+":///test.server",\n        grpc.WithDefaultServiceConfig(fmt.Sprintf(`{"loadBalancingConfig": [{"%s":{}}]}`, p2c.Name)))\n    if err != nil {\n        t.Fatalf("failed to dial: %v", err)\n    }\n    defer cc.Close()\n}\n\n')),(0,i.kt)("h1",{id:"references"},"references"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://mp.weixin.qq.com/s/J8s-nqJnvL_knRD1XjOpNA"},"\u8d1f\u8f7d\u5747\u8861p2c\u7b97\u6cd5")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://corporatefinanceinstitute.com/resources/knowledge/trading-investing/exponentially-weighted-moving-average-ewma/"},"Exponentially Weighted Moving Average (EWMA)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.wallstreetmojo.com/ewma/"},"Definition of EWMA")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.jianshu.com/p/6d16f9a4351c"},"\u6307\u6570\u52a0\u6743\u5e73\u5747\u7b97\u6cd5")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://blog.51cto.com/u_9269309/1865554"},"\u725b\u987f\u51b7\u5374\u5b9a\u5f8b\u7684\u65f6\u95f4\u8870\u51cf\u51fd\u6570\u6a21\u578b")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.ruanyifeng.com/blog/2012/03/ranking_algorithm_newton_s_law_of_cooling.html"},"\u725b\u987f\u51b7\u5374\u5b9a\u5f8b")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://exceting.github.io/2020/08/13/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-P2C%E7%AE%97%E6%B3%95/"},"\u8d1f\u8f7d\u5747\u8861p2c\u7b97\u6cd5\u6570\u636e")," "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/grpc/grpc-go/blob/master/balancer/roundrobin/roundrobin.go"},"grpc\u8f6e\u8be2\u7b97\u6cd5"))))}g.isMDXComponent=!0},6367:function(e,n,t){n.Z=t.p+"assets/images/image-20220412003955372-94f53b1b167231312c71d71269794b7e.png"},2502:function(e,n,t){n.Z=t.p+"assets/images/image-20220412004052835-f207d03d76a2ef8524af4bace9732bde.png"},9092:function(e,n,t){n.Z=t.p+"assets/images/image-20220412010038364-66c4077184f94563f486883eb97be0a5.png"},1866:function(e,n,t){n.Z=t.p+"assets/images/image-20220412101142089-8cfda1a2f90c31e5a9c216b5730c4f24.png"}}]);